# Tiled Ensemble 异常检测工具

基于 Anomalib 的分块集成异常检测工具，专为 PCB 等大尺寸图像设计。

## 📋 目录

- [项目简介](#项目简介)
  - [Anomalib库是什么](#anomalib库是什么)
  - [常见异常检测模型](#常见异常检测模型)
  - [为什么选择PatchCore](#为什么选择patchcore)
- [系统工作原理](#系统工作原理)
  - [训练流程](#训练流程)
  - [预测流程](#预测流程)
- [功能特性](#功能特性)
- [文件结构](#文件结构)
- [快速开始](#快速开始)
  - [训练模型](#训练模型)
  - [预测推理](#预测推理)
- [配置说明](#配置说明)
- [进阶功能](#进阶功能)

---

## 📖 项目简介

### Anomalib库是什么

**Anomalib** 是由英特尔（Intel）开源的深度学习异常检测库，专门用于**工业质量检测**场景。

**通俗解释：**
- **目的**：自动检测产品缺陷，替代人工肉眼检查
- **优势**：只需要正常样本即可训练，无需大量标注缺陷样本
- **应用场景**：PCB板检测、金属表面检测、布料瑕疵检测等

**核心理念：**
```
正常样本训练 → 学习"正常"的模式 → 识别"不正常"的异常
```

**为什么它适合工业检测？**
1. **训练简单**：只需收集正常产品图片（良品），无需标注缺陷位置
2. **检测全面**：能发现训练时未见过的各种缺陷类型
3. **可视化好**：生成热力图，直观显示缺陷位置
4. **性能高效**：推理速度快，适合实时生产线检测

---

### 常见异常检测模型

Anomalib 提供了多种业界领先的异常检测模型，以下是主要几种：

| 模型 | 特点 | 训练速度 | 检测精度 | 适用场景 |
|------|------|---------|---------|----------|
| **PatchCore** | ⭐ 推荐 | 快（无需训练） | ⭐⭐⭐⭐⭐ | 通用场景，精度最高 |
| **PaDiM** | 轻量级 | 快（无需训练） | ⭐⭐⭐⭐ | 资源受限设备 |
| **FastFlow** | 速度快 | 中等 | ⭐⭐⭐⭐ | 实时检测 |
| **EfficientAD** | 最新 | 快 | ⭐⭐⭐⭐ | 平衡速度和精度 |
| **STFPM** | 知识蒸馏 | 慢 | ⭐⭐⭐ | 学术研究 |
| **GANomaly** | GAN架构 | 慢 | ⭐⭐⭐ | 复杂纹理 |

**各模型工作原理简介：**

1. **PatchCore（本项目使用）**
   - 原理：提取图像的特征块（patches），建立"正常特征库"
   - 检测：计算测试图像与正常特征库的相似度，差异大则为异常
   - 优势：无需梯度训练，速度快且精度极高

2. **PaDiM**
   - 原理：对每个像素位置建立高斯分布模型
   - 检测：计算像素偏离正常分布的程度
   - 优势：内存占用小，适合嵌入式设备

3. **FastFlow**
   - 原理：使用归一化流（Normalizing Flow）建模特征分布
   - 检测：计算特征的对数似然
   - 优势：推理速度极快

---

### 为什么选择PatchCore

在本项目中，我们选择 **PatchCore** 作为核心算法，原因如下：

#### ✅ 优势

1. **无需训练过程**
   - 传统方法：需要数小时甚至数天训练神经网络
   - PatchCore：只需几分钟"记忆"正常样本特征，无需反向传播
   - **实际意义**：快速部署，节省时间和计算资源

2. **检测精度业界领先**
   - 在 MVTec AD（工业检测标准数据集）上精度排名前列
   - 像素级定位准确，能精确标出缺陷位置
   - **实际意义**：漏检率低，误报率低，可靠性高

3. **泛化能力强**
   - 能检测训练时未见过的新型缺陷
   - 对光照、角度变化鲁棒性好
   - **实际意义**：适应生产环境的多样性

4. **可解释性好**
   - 生成的热力图直观显示异常区域
   - 可以追溯判断依据（与哪个正常样本差异大）
   - **实际意义**：便于质检人员复核和分析

#### ⚠️ 局限性

1. **内存占用较大**
   - 需要存储大量正常样本的特征向量
   - 解决方案：本项目通过分块处理降低内存需求

2. **推理速度中等**
   - 比 FastFlow 等模型稍慢
   - 解决方案：使用 GPU 加速，实际速度仍可满足工业需求

#### 📊 性能对比（MVTec AD 数据集）

| 指标 | PatchCore | PaDiM | FastFlow |
|-----|-----------|-------|----------|
| 图像级准确率 | **99.6%** | 97.9% | 98.7% |
| 像素级准确率 | **98.1%** | 96.5% | 97.2% |
| 推理速度 | 20 FPS | 30 FPS | 50 FPS |
| GPU 内存 | 2GB | 1GB | 1.5GB |

**结论**：PatchCore 在精度和泛化性上的优势，远超过其在速度和内存上的劣势，是工业应用的最佳选择。

---

## 🔄 系统工作原理

### 系统架构概览

下图展示了 Tiled Ensemble 的完整系统架构，从输入图像到最终输出的整个流程：

![Tiled Ensemble 系统架构](system_architecture.png)

**架构说明：**

1. **Tiling Mechanism（分块机制）**
   - 将输入的大尺寸图像切分成多个小块（tiles）
   - 本项目配置：512×512 图像 → 4 个 256×256 的块
   - 每个块独立处理，提高检测精度和效率

2. **Ensemble of Models（模型集成）**
   - 每个 tile 对应一个独立训练的 PatchCore 模型
   - 4 个模型并行工作，分别检测各自区域
   - 集成学习提高整体检测性能和鲁棒性

3. **Merging Mechanism（合并机制）**
   - 将各个 tile 的预测结果拼接成完整的异常热力图
   - 合并各模型的异常分数，计算整体评估结果
   - 保证结果的连续性和一致性

4. **Post-processing（后处理流程）**
   - **Smoothing（平滑）**：消除 tile 拼接处的接缝伪影
   - **Normalize（归一化）**：将异常分数映射到 [0, 1] 区间
   - **Threshold（阈值）**：应用阈值判断 OK/NG（默认 0.5）
   - **Visualize（可视化）**：生成热力图和三合一结果图
   - **Metrics（指标）**：计算评估指标（准确率、F1等）

5. **Pipeline（流水线）**
   - 整个流程自动化串联
   - 从原始图像到最终判断结果一键完成
   - 支持批量处理多张图像

---

### 训练流程

下面用通俗语言解释系统如何"学习"正常产品的样子：

```
┌──────────────────────────────────────────────────────┐
│ 第1步：准备数据                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 收集 100+ 张正常产品图片（良品）                   │
│ • 可选：收集少量缺陷图片用于测试（非必需）           │
│ • 图片要求：清晰、光照均匀、拍摄角度一致             │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第2步：图像预处理                                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 自动裁剪黑色背景（保留PCB有效区域）                │
│ • 统一调整为 512×512 像素                           │
│ • 数据增强：随机旋转、亮度调整（增加鲁棒性）         │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第3步：分块处理                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 将 512×512 图像切成 4 块（2×2 网格）              │
│ • 每块大小：256×256 像素                            │
│ • 为什么分块？处理大图更高效，细节捕捉更准确         │
│                                                      │
│   ┌──────┬──────┐                                  │
│   │ 块0  │ 块1  │  ← 每块独立处理                  │
│   ├──────┼──────┤                                  │
│   │ 块2  │ 块3  │                                  │
│   └──────┴──────┘                                  │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第4步：特征提取（核心步骤）                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 使用预训练的 ResNet 神经网络提取特征               │
│ • 特征包含：纹理、边缘、形状、颜色等高维信息         │
│ • 对每个块建立"正常特征库"（Memory Bank）            │
│                                                      │
│   正常样本1 → [特征向量1]                           │
│   正常样本2 → [特征向量2]  } 存入特征库             │
│   正常样本N → [特征向量N]                           │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第5步：保存模型                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 保存 4 个模型文件（对应 4 个块）                   │
│   - model0_0.ckpt（左上）                           │
│   - model0_1.ckpt（右上）                           │
│   - model1_0.ckpt（左下）                           │
│   - model1_1.ckpt（右下）                           │
│                                                      │
│ • 使用验证集统计信息 保存至stats.json
|   - 最佳阈值                                               │
│   - 正常样本的异常分数范围                           │
│   - 用于后续归一化判断                               │
└──────────────────────────────────────────────────────┘
                        ↓ （可选）
┌──────────────────────────────────────────────────────┐
│ 第6步：自动测试评估                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 用预留的测试样本验证模型效果                       │
│ • 生成评估报告：准确率、误报率、漏检率               │
│ • 保存可视化结果到 results/ 目录                     │
└──────────────────────────────────────────────────────┘

⏱️  整个训练过程通常只需 5-15 分钟（取决于数据量）
```

**关键概念解释：**

- **特征提取**：就像人眼看图时会注意纹理、颜色、形状，神经网络也会提取这些抽象特征
- **特征库（Memory Bank）**：就像建立一个"正常产品档案库"，存储所有正常样本的特征
- **分块训练**：类似于把大海报分成小块分别扫描，最后再拼起来

---

### 预测流程

下面解释系统如何判断一张新图片是正常还是异常：

```
┌──────────────────────────────────────────────────────┐
│ 第1步：加载模型和配置                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 加载 4 个训练好的模型                              │
│ • 加载 stats.json（统计信息）                        │
│ • [可选] 加载 ROI 区域配置                           │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第2步：[可选] 选择感兴趣区域（ROI）                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 首次运行时，弹出窗口让您框选关注区域               │
│ • 用途：忽略文字、标签等已知的"假异常"               │
│ • 操作：鼠标拖动框选 → 按 's' 保存 → 按 'q' 继续    │
│                                                      │
│   ┌─────────────────────────┐                       │
│   │  PCB图                  │                       │
│   │  ┌──────────┐            │                      │
│   │  │  ROI区域 │ ← 只检测这里                     │
│   │  └──────────┘            │                      │
│   │     [文字区域] ← 忽略    │                       │
│   └─────────────────────────┘                       │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第3步：读取待检测图像                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 从指定目录读取图像                                 │
│ • 支持格式：jpg、png、jpeg                          │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第4步：图像预处理（与训练相同）                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 自动裁剪图片背景--->解决高度不一致带来的误报                                   │
│ • 调整为 512×512 像素                               │
│ • 切分成 4 个 256×256 块                            │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第5步：分块预测（核心检测）                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 每个块用对应的模型进行检测：                       │
│                                                      │
│   块0 (左上) + model0_0.ckpt → 异常图0              │
│   块1 (右上) + model0_1.ckpt → 异常图1              │
│   块2 (左下) + model1_0.ckpt → 异常图2              │
│   块3 (右下) + model1_1.ckpt → 异常图3              │
│                                                      │
│ • 检测原理：                                         │
│   1. 提取当前块的特征向量                            │
│   2. 与训练时的"正常特征库"对比                      │
│   3. 计算最小距离（相似度）                          │
│   4. 距离大 → 异常，距离小 → 正常                   │
│                                                      │
│   测试特征 ──计算距离──→ 正常特征库                 │
│   [新图块]              [训练样本1]                 │
│                         [训练样本2]                 │
│                         [训练样本N]                 │
│                              ↓                       │
│                         找最相似的 → 计算异常分数    │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第6步：结果合并与后处理                              │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 拼接 4 个异常图 → 完整异常热力图                   │
│                                                      │
│   ┌────┬────┐      ┌──────────┐                    │
│   │图0 │图1 │      │          │                     │
│   ├────┼────┤  →  │ 完整热力图│                    │
│   │图2 │图3 │      │          │                     │
│   └────┴────┘      └──────────┘                    │
│                                                      │
│ • 接缝平滑：消除拼接处的边界痕迹                     │
│ • 归一化：将分数映射到 [0, 1] 区间                  │
│ • [可选] 应用 ROI mask：只计算关注区域的分数        │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第7步：OK/NG 判断                                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 计算整张图的异常分数（0.0 ~ 1.0）                 │
│                                                      │
│   分数 < 0.5  →  ✅ OK（正常）                      │
│   分数 ≥ 0.5  →  ❌ NG（异常）                      │
│                                                      │
│ • 为什么阈值是 0.5？                                 │
│   训练时会找到最佳分界点，归一化后映射到 0.5         │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第8步：生成可视化结果                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 生成三合一结果图：                                 │
│                                                      │
│   ┌─────────┬──────────┬──────────┐                │
│   │ 原始图  │ 热力图叠加│ 异常区域 │                 │
│   │         │ OK 0.23  │          │                 │
│   └─────────┴──────────┴──────────┘                │
│                                                      │
│ • 热力图颜色：                                       │
│   - 蓝色/绿色：正常区域                              │
│   - 黄色/橙色：可疑区域                              │
│   - 红色：异常区域                                   │
│                                                      │
│ • 保存文件命名：图片名_判断结果_分数.jpg             │
│   例如：test_001_OK_0.234.jpg                       │
│         test_002_NG_0.678.jpg                       │
└──────────────────────────────────────────────────────┘

⏱️  单张图预测速度：1-2 秒/张（使用 GPU）
```

**关键概念解释：**

- **异常分数**：数值越高表示越不正常，0表示完全正常，1表示完全异常
- **热力图**：用颜色表示异常程度，红色=异常，蓝色=正常
- **接缝平滑**：因为图像被切成4块分别检测，拼接时会有边界痕迹，需要平滑处理
- **ROI（Region of Interest）**：感兴趣区域，只检测这些区域，忽略其他位置

---

### 测试流程

测试和预测的主要区别：

| 对比项 | 预测（Predict） | 测试（Test） |
|--------|----------------|-------------|
| **目的** | 检测未知样本 | 评估模型性能 |
| **数据** | 新的生产图片 | 已知标签的测试集 |
| **输出** | OK/NG + 可视化 | 准确率、F1分数等指标 |
| **使用时机** | 生产环境实时检测 | 模型验证和调优 |

**测试流程：**

```
训练完成后 → 自动运行测试
         ↓
使用测试集（正常 + 异常样本）
         ↓
计算评估指标：
  • 图像级准确率（整张图判断对错）
  • 像素级准确率（缺陷位置标注精度）
  • F1 分数（准确率和召回率的平衡）
  • AUROC（受试者工作特征曲线下面积）
         ↓
保存评估报告和可视化结果
```

---

### 预测结果示例

下面展示三个实际的预测结果，帮助您直观理解系统的检测效果：

#### 示例 1：正常样本 - OK（异常分数：0.455）

![预测结果示例1](examples/Image_534_OK_0.455.jpg)

**分析说明：**
- **判断结果**：✅ OK（正常）
- **异常分数**：0.455（< 0.5 阈值，判定为正常）
- **热力图分析**：
  - 大部分区域呈现蓝色/绿色（正常）
  - 黄色变压器区域有轻微异常反应（电感元件的正常现象）
  - 红色圈出的区域是预设的ROI关注区域
- **结论**：整体得分低于阈值，PCB板无明显缺陷

#### 示例 2：正常样本 - OK（异常分数：0.460）

![预测结果示例2](examples/Image_2026_OK_0.460.jpg)

**分析说明：**
- **判断结果**：✅ OK（正常）
- **异常分数**：0.460（< 0.5 阈值，判定为正常）
- **热力图分析**：
  - 整体呈现蓝色调，异常程度很低
  - 黄色变压器区域的异常值略高（这是正常的，因为该元件纹理特殊）
  - 右侧的异常区域图几乎全黑，说明无明显异常
- **结论**：这是一个典型的良品样本

#### 示例 3：异常样本 - NG（异常分数：0.777）

![预测结果示例3](examples/Image_2665_NG_0.777.jpg)

**分析说明：**
- **判断结果**：❌ NG（异常）
- **异常分数**：0.777（≥ 0.5 阈值，判定为异常）
- **热力图分析**：
  - 黄色变压器区域呈现明显的红色/黄色高亮
  - 热力图叠加显示该区域与正常样本差异显著
  - 右侧的异常区域图清晰显示出缺陷位置（白色区域）
- **缺陷类型**：变压器上的红色 "V" 形标记（训练时未见过的异常）
- **结论**：系统成功检测出明显的产品异常

---

#### 📊 结果对比总结

| 样本 | 判断 | 分数 | 特征描述 |
|------|------|------|----------|
| Image_534 | ✅ OK | 0.455 | 正常PCB，轻微异常值在可接受范围 |
| Image_2026 | ✅ OK | 0.460 | 典型良品，异常值极低 |
| Image_2665 | ❌ NG | 0.777 | 变压器区域存在明显缺陷标记 |

**关键观察点：**
1. **阈值分界清晰**：0.5 作为分界点，能有效区分正常和异常样本
2. **热力图可解释性强**：红色区域直接指示缺陷位置，便于人工复核
3. **误报控制良好**：即使黄色元件在所有样本中都显示较高异常值（因其特殊纹理），但不影响整体判断
4. **细节捕捉能力强**：能检测出小尺寸的异常标记（如示例3的"V"形标记）

---

## 🎯 功能特性

- **分块集成训练**：将大尺寸图像切分成多个 tiles，每个 tile 训练独立模型
- **智能接缝平滑**：自动平滑相邻 tiles 拼接处，消除接缝伪影
- **PCB 背景裁剪**：自动检测并裁剪 PCB 边缘，去除黑色背景干扰
- **ROI 区域选择**：支持指定感兴趣区域，忽略不相关区域的异常
- **可视化输出**：生成原图、热力图叠加、异常区域三合一可视化结果

---

## 📁 文件结构

```
tools/tiled_ensemble/
├── train.py                    # 训练脚本
├── predict.py                  # 预测脚本（独立版，包含完整功能）
├── eval.py                     # 评估脚本
├── ens_config.yaml             # 训练配置文件
├── predict_config.yaml         # 预测配置文件
├── visualize_heatmap.py        # 热图可视化工具
├── roi.json                    # ROI 配置文件（预测时生成）
├── roi_mask.png                # ROI 掩码图像（预测时生成）
└── README.md                   # 本文档
```

---

## 🚀 快速开始

### 训练模型

#### 1. 准备数据集

按照以下结构组织您的数据：

```
datasets/pcb/
├── good/              # 正常样本（训练 + 测试）
│   ├── image_001.png
│   ├── image_002.png
│   └── ...
└── defect/            # 异常样本（仅测试）
    ├── defect_001.jpg
    ├── defect_002.jpg
    └── ...
```

#### 2. 配置训练参数

编辑 `ens_config.yaml`，根据需要调整参数：

```yaml
# 数据配置
data:
  class_path: anomalib.data.Folder
  init_args:
    root: datasets/pcb          # 数据集根目录
    normal_dir: good            # 正常样本目录
    abnormal_dir: defect        # 异常样本目录
    normal_split_ratio: 0.2     # 20% 正常样本用于测试

# 分块配置
tiling:
  image_size: [512, 512]        # 调整后的图像尺寸
  tile_size: [256, 256]         # 每个 tile 的尺寸
  stride: 256                   # 步长（256 表示无重叠）

# 模型配置
TrainModels:
  model:
    class_path: Patchcore       # 使用 PatchCore 模型
  trainer:
    max_epochs: 1               # PatchCore 只需 1 个 epoch
```

**关键参数说明：**

- `image_size: [512, 512]` + `tile_size: [256, 256]` + `stride: 256`
  - 图像被切分成 **2×2 = 4 个 tiles**
  - 每个 tile 训练一个独立的 PatchCore 模型
  
- `normalization_stage: image`
  - 在整张图像级别进行归一化（推荐）
  
- `SeamSmoothing`
  - 自动平滑 tile 接缝区域，消除拼接痕迹

#### 3. 运行训练

```bash
cd tools/tiled_ensemble
python train.py
```

**训练流程：**

1. 加载数据集并应用 PCB 背景裁剪（如果启用）
2. 将图像调整为 512×512
3. 切分成 4 个 256×256 的 tiles
4. 为每个 tile 训练独立的 PatchCore 模型
5. 保存 4 个模型权重文件：
   - `model0_0.ckpt` - 左上 tile
   - `model0_1.ckpt` - 右上 tile
   - `model1_0.ckpt` - 左下 tile
   - `model1_1.ckpt` - 右下 tile
6. 保存归一化统计信息：`stats.json`
7. 自动运行测试评估

**训练结果保存位置：**

```
results/PatchCore/pcb/latest/
├── weights/
│   └── lightning/
│       ├── model0_0.ckpt       # 左上 tile 模型
│       ├── model0_1.ckpt       # 右上 tile 模型
│       ├── model1_0.ckpt       # 左下 tile 模型
│       ├── model1_1.ckpt       # 右下 tile 模型
│       └── stats.json          # 归一化统计信息
└── images/                     # 测试结果可视化
```

---

### 预测推理

#### 1. 准备预测数据

将待预测的图像放入指定目录：

```
datasets/pcb/predict/
├── test_001.jpg
├── test_002.png
└── ...
```

#### 2. 配置预测参数

编辑 `predict_config.yaml`：

```yaml
# 路径配置
paths:
  checkpoint_dir: "results/PatchCore/pcb/latest/weights/lightning"  # 模型目录
  input_dir: "datasets/pcb/predict"                                 # 输入目录
  output_dir: "datasets/pcb/predict_results"                        # 输出目录

# PCB 裁剪配置
pcb_crop:
  enable: true              # 启用 PCB 背景裁剪
  padding: 10               # 裁剪边距（像素）
  min_area_ratio: 0.1       # PCB 最小面积占比

# 接缝平滑配置
seam_smoothing:
  apply: true               # 启用接缝平滑
  sigma: 2                  # 高斯核 sigma
  width: 0.1                # 平滑区域宽度占比

# ROI 配置
roi:
  enable: true              # 启用 ROI 过滤
  config_path: null         # null = 首次运行时选择 ROI

# 判断阈值
threshold:
  normalized_threshold: 0.5 # 判断阈值（标准值 0.5）
                            # 分数 ≥ 0.5 → NG (异常)
                            # 分数 < 0.5 → OK (正常)
```

#### 3. 运行预测

```bash
cd tools/tiled_ensemble
python predict.py
```

**预测流程：**

```
步骤 1: 加载归一化统计信息 (stats.json)
    ↓
步骤 2: 加载 4 个模型 (model0_0.ckpt ~ model1_1.ckpt)
    ↓
步骤 3: [可选] ROI 选择
    - 如果 enable: true 且 config_path: null
    - 会弹出窗口让您选择 ROI 区域
    - 操作：
      * 左键拖动：选择矩形 ROI
      * 's': 保存 ROI 配置
      * 'r': 重置所有 ROI
      * 'q': 完成并继续
    ↓
步骤 4: 遍历所有图像
    ├── PCB 背景裁剪（自动去除黑边）
    ├── 调整为 512×512
    ├── 切分成 4 个 tiles (256×256)
    ├── 每个 tile 用对应模型预测
    ├── 合并预测结果
    ├── 接缝平滑（消除拼接痕迹）
    ├── 归一化到 [0, 1]
    ├── [可选] 应用 ROI mask
    └── 判断 OK/NG
    ↓
步骤 5: 保存可视化结果
```

**预测结果输出：**

```
datasets/pcb/predict_results/
├── test_001_OK_0.234.jpg       # 正常样本（分数 < 0.5）
├── test_002_NG_0.678.jpg       # 异常样本（分数 ≥ 0.5）
└── ...
```

每张结果图包含三个子图：
1. **Original** - 原始图像（裁剪后）
2. **Anomaly Overlay** - 热力图叠加（显示判断结果和分数）
3. **Anomaly Region** - 异常区域高亮（黑色背景 + 红色边框）

---

## ⚙️ 配置说明

### 训练配置 (ens_config.yaml)

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `tiling.image_size` | 调整后的图像尺寸 | [512, 512] |
| `tiling.tile_size` | 每个 tile 的尺寸 | [256, 256] |
| `tiling.stride` | 切分步长 | 256 |
| `normalization_stage` | 归一化阶段 | image |
| `thresholding_stage` | 阈值应用阶段 | image |
| `SeamSmoothing.apply` | 是否平滑接缝 | True |
| `SeamSmoothing.sigma` | 高斯核 sigma | 2 |
| `SeamSmoothing.width` | 平滑区域宽度因子 | 0.1 |
| `data.normal_split_ratio` | 正常样本测试集比例 | 0.2 |
| `TrainModels.trainer.max_epochs` | 训练轮数 | 1 |

### 预测配置 (predict_config.yaml)

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `paths.checkpoint_dir` | 模型权重目录 | results/PatchCore/pcb/latest/weights/lightning |
| `paths.input_dir` | 输入图像目录 | datasets/pcb/predict |
| `paths.output_dir` | 结果输出目录 | datasets/pcb/predict_results |
| `pcb_crop.enable` | 启用 PCB 裁剪 | true |
| `pcb_crop.padding` | 裁剪边距（像素） | 10 |
| `pcb_crop.min_area_ratio` | PCB 最小面积占比 | 0.1 |
| `seam_smoothing.apply` | 启用接缝平滑 | true |
| `seam_smoothing.sigma` | 高斯核 sigma | 2 |
| `seam_smoothing.width` | 平滑区域宽度占比 | 0.1 |
| `roi.enable` | 启用 ROI 过滤 | true |
| `roi.config_path` | ROI 配置文件路径 | null |
| `threshold.normalized_threshold` | 判断阈值 | 0.5 |

---

## 🔧 进阶功能

### 1. PCB 背景裁剪

**功能：** 自动检测 PCB 边缘，裁剪黑色背景，保留有效区域。

**原理：**
- Canny 边缘检测
- 形态学膨胀和闭运算
- 寻找最大轮廓
- 计算包围矩形并裁剪

**配置：**

```yaml
pcb_crop:
  enable: true              # 启用裁剪
  padding: 10               # 边距（像素）
  min_area_ratio: 0.1       # 最小面积占比（过滤误检）
```

**效果：**
- 输入：2000×2000 图像（大部分是黑色背景）
- 输出：1200×1400 图像（仅 PCB 区域 + 10px 边距）

### 2. ROI 区域选择

**功能：** 指定感兴趣区域，忽略其他区域的异常。

**使用场景：**
- PCB 上有固定的文字区域（正常但可能被误判为异常）
- 只关心特定区域的缺陷
- 边缘区域容易误报

**操作步骤：**

1. 配置启用 ROI：
   ```yaml
   roi:
     enable: true
     config_path: null  # 首次运行时选择
   ```

2. 运行预测：
   ```bash
   python predict.py
   ```

3. 在弹出的窗口中：
   - **左键拖动**：框选 ROI 区域（可以选多个）
   - **'s' 键**：保存 ROI 配置（保存到 `roi.json` 和 `roi_mask.png`）
   - **'r' 键**：重置所有 ROI
   - **'q' 键**：完成并继续预测

4. 后续预测会自动使用保存的 ROI：
   ```yaml
   roi:
     enable: true
     config_path: "roi.json"  # 自动加载
   ```

**工作原理：**
- 预测时只计算 ROI 内的异常分数
- ROI 外的区域异常值被置为 0
- 最终分数 = ROI 内平均异常值

### 3. 接缝平滑

**功能：** 平滑相邻 tiles 拼接处，消除接缝伪影。

**原理：**
- 识别 tile 接缝位置（行/列边界）
- 构建接缝 mask（接缝周围一定宽度）
- 对接缝区域应用高斯模糊
- 融合平滑后的结果

**配置：**

```yaml
seam_smoothing:
  apply: true               # 启用平滑
  sigma: 2                  # 高斯核 sigma（越大越模糊）
  width: 0.1                # 平滑区域宽度占比（相对 tile 边长）
```

**效果：**
- 消除 tile 拼接处的明显边界
- 使热力图更加连续平滑

### 4. 判断阈值调整

**功能：** 调整 OK/NG 判断的敏感度。

**配置：**

```yaml
threshold:
  normalized_threshold: 0.5  # 默认值
```

**调整建议：**
- **提高阈值（如 0.6）**：减少误报（NG → OK），可能漏检
- **降低阈值（如 0.4）**：减少漏检（OK → NG），可能误报
- **建议范围**：0.4 ~ 0.6

**示例：**

| 阈值 | 效果 | 适用场景 |
|------|------|----------|
| 0.3 | 极其敏感 | 允许误报，绝不漏检（如医疗） |
| 0.4 | 较敏感 | 减少漏检 |
| 0.5 | 标准 | 平衡误报和漏检（推荐） |
| 0.6 | 较宽松 | 减少误报 |
| 0.7 | 宽松 | 只标记明显异常 |

### 5. 归一化说明

**训练时：**
1. 收集所有训练样本的异常分数
2. 计算阈值（如 F1-score 最优点）
3. 保存统计信息到 `stats.json`：
   ```json
   {
     "minmax": {
       "anomaly_map": {"min": 0.0, "max": 25.5},
       "pred_score": {"min": 2.1, "max": 18.3}
     },
     "pixel_threshold": 12.4,
     "image_threshold": 9.8
   }
   ```

**预测时：**
1. 加载 `stats.json`
2. 使用训练时的统计信息归一化：
   ```python
   normalized = ((value - threshold) / (max - min)) + 0.5
   ```
3. 将阈值映射到 0.5，其他值按比例缩放
4. 最终分数范围：[0, 1]

**为什么阈值是 0.5？**
- 训练时的最优阈值被映射到 0.5
- 预测时 ≥ 0.5 表示超过训练阈值 → NG
- 预测时 < 0.5 表示低于训练阈值 → OK

---

## 📊 工作流程图

```
┌─────────────────────────────────────────────────────────┐
│                     训练阶段                            │
└─────────────────────────────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │    加载数据集 (good + defect)    │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  [可选] PCB 背景裁剪            │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │    调整为 512×512               │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  切分成 2×2 = 4 个 tiles        │
         │  (每个 256×256)                 │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  每个 tile 训练独立模型         │
         │  - model0_0.ckpt (左上)         │
         │  - model0_1.ckpt (右上)         │
         │  - model1_0.ckpt (左下)         │
         │  - model1_1.ckpt (右下)         │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  保存统计信息 (stats.json)      │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │    测试评估                     │
         └─────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                     预测阶段                            │
└─────────────────────────────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  加载模型和统计信息             │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  [可选] 选择 ROI 区域           │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  读取图像                       │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  [可选] PCB 背景裁剪            │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  调整为 512×512                 │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  切分成 4 个 tiles              │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  每个 tile 用对应模型预测       │
         │  - Tile 0 → model0_0.ckpt       │
         │  - Tile 1 → model0_1.ckpt       │
         │  - Tile 2 → model1_0.ckpt       │
         │  - Tile 3 → model1_1.ckpt       │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  合并预测结果                   │
         │  - 拼接 anomaly_map             │
         │  - 平均 pred_score              │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  [可选] 接缝平滑                │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  归一化到 [0, 1]                │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  [可选] 应用 ROI mask           │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  判断 OK/NG                     │
         │  (分数 ≥ 0.5 → NG)             │
         └─────────────────────────────────┘
                           │
                           ↓
         ┌─────────────────────────────────┐
         │  生成可视化结果                 │
         └─────────────────────────────────┘
```

---

## 🛠️ 故障排查

### 问题 1: 找不到模型文件

**错误信息：**
```
❌ 找不到模型: results/PatchCore/pcb/latest/weights/lightning/model0_0.ckpt
```

**解决方法：**
1. 检查训练是否成功完成
2. 确认 `predict_config.yaml` 中的 `checkpoint_dir` 路径正确
3. 检查模型目录是否包含所有 4 个模型文件

### 问题 2: 找不到 stats.json

**错误信息：**
```
❌ 找不到 stats.json: results/PatchCore/pcb/latest/weights/lightning/stats.json
```

**解决方法：**
1. 重新运行训练（`stats.json` 在训练时生成）
2. 确认训练完全完成（未中断）

### 问题 3: PCB 裁剪失败

**警告信息：**
```
⚠️  PCB裁剪失败，使用原图
```

**可能原因：**
- 图像背景不是黑色
- PCB 边缘不明显
- 图像对比度过低

**解决方法：**
1. 调整 `min_area_ratio` 参数（降低到 0.05）
2. 禁用 PCB 裁剪：`pcb_crop.enable: false`

### 问题 4: ROI 选择窗口不显示

**可能原因：**
- OpenCV 窗口被其他窗口遮挡
- 显示器设置问题

**解决方法：**
1. 检查任务栏是否有 OpenCV 窗口
2. 按 Alt+Tab 切换窗口
3. 如果无法使用 ROI，禁用该功能：`roi.enable: false`

### 问题 5: GPU 内存不足

**错误信息：**
```
CUDA out of memory
```

**解决方法：**
1. 减少 `batch_size`（在 `ens_config.yaml` 中）
2. 使用 CPU：在 `predict_config.yaml` 中设置 `device: "cpu"`
3. 关闭其他占用 GPU 的程序

---

## 📝 注意事项

1. **训练前必读：**
   - 确保正常样本足够多（建议 > 100 张）
   - 异常样本仅用于测试，不参与训练
   - 图像尺寸最好接近 512×512（或更大）

2. **预测前必读：**
   - 必须先完成训练
   - 确保 `stats.json` 和 4 个模型文件都存在
   - 预测图像应与训练图像来自同一场景/设备

3. **参数调整建议：**
   - 如果误报多：提高 `normalized_threshold`（如 0.6）
   - 如果漏检多：降低 `normalized_threshold`（如 0.4）
   - 如果接缝明显：增大 `seam_smoothing.width`（如 0.15）

4. **性能优化：**
   - 使用 GPU 可显著加速（推荐 CUDA）
   - 预测时可以批量处理多张图像
   - 如果图像很大，考虑增加 `tile_size` 到 512×512

---

## 📚 参考资料

- [Anomalib 官方文档](https://anomalib.readthedocs.io/)
- [PatchCore 论文](https://arxiv.org/abs/2106.08265)
- [Tiled Ensemble 设计思想](https://anomalib.readthedocs.io/en/latest/markdown/guides/reference/pipelines/tiled_ensemble.html)

---

## 🤝 贡献与反馈

如有问题或建议，请联系项目维护者。

---

**最后更新：** 2026-01-12

