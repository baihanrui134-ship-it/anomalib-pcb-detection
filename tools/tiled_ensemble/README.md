# Tiled Ensemble 异常检测工具

基于 Anomalib 的分块集成异常检测工具，专为 PCB 等大尺寸图像设计。

## 📋 目录

- [项目简介](#项目简介)
  - [Anomalib库是什么](#anomalib库是什么)
  - [常见异常检测模型](#常见异常检测模型)
  - [为什么选择PatchCore](#为什么选择patchcore)
- [系统工作原理](#系统工作原理)
  - [训练流程](#训练流程)
  - [预测流程](#预测流程)
- [功能特性](#功能特性)
- [文件结构](#文件结构)
- [快速开始](#快速开始)
  - [训练模型](#训练模型)
  - [预测推理](#预测推理)
- [配置说明](#配置说明)
- [进阶功能](#进阶功能)

---

## 📖 项目简介

### Anomalib库是什么

**Anomalib** 是由英特尔（Intel）开源的深度学习异常检测库，专门用于**工业质量检测**场景。

**通俗解释：**
- **目的**：自动检测产品缺陷，替代人工肉眼检查
- **优势**：只需要正常样本即可训练，无需大量标注缺陷样本
- **应用场景**：PCB板检测、金属表面检测、布料瑕疵检测等

**核心理念：**
```
正常样本训练 → 学习"正常"的模式 → 识别"不正常"的异常
```

**为什么它适合工业检测？**
1. **训练简单**：只需收集正常产品图片（良品），无需标注缺陷位置
2. **检测全面**：能发现训练时未见过的各种缺陷类型
3. **可视化好**：生成热力图，直观显示缺陷位置
4. **性能高效**：推理速度快，适合实时生产线检测

---

### 常见异常检测模型

Anomalib 提供了多种业界领先的异常检测模型，以下是主要几种：

| 模型 | 特点 | 训练速度 | 检测精度 | 适用场景 |
|------|------|---------|---------|----------|
| **PatchCore** | ⭐ 推荐 | 快（无需训练） | ⭐⭐⭐⭐⭐ | 通用场景，精度最高 |
| **PaDiM** | 轻量级 | 快（无需训练） | ⭐⭐⭐⭐ | 资源受限设备 |
| **FastFlow** | 速度快 | 中等 | ⭐⭐⭐⭐ | 实时检测 |
| **EfficientAD** | 最新 | 快 | ⭐⭐⭐⭐ | 平衡速度和精度 |
| **STFPM** | 知识蒸馏 | 慢 | ⭐⭐⭐ | 学术研究 |
| **GANomaly** | GAN架构 | 慢 | ⭐⭐⭐ | 复杂纹理 |

**各模型工作原理简介：**

1. **PatchCore（本项目使用）**
   - 原理：提取图像的特征块（patches），建立"正常特征库"
   - 检测：计算测试图像与正常特征库的相似度，差异大则为异常
   - 优势：无需梯度训练，速度快且精度极高

2. **PaDiM**
   - 原理：对每个像素位置建立高斯分布模型
   - 检测：计算像素偏离正常分布的程度
   - 优势：内存占用小，适合嵌入式设备

3. **FastFlow**
   - 原理：使用归一化流（Normalizing Flow）建模特征分布
   - 检测：计算特征的对数似然
   - 优势：推理速度极快

---

### 为什么选择PatchCore

在本项目中，我们选择 **PatchCore** 作为核心算法，原因如下：

#### ✅ 优势

1. **无需训练过程**
   - 传统方法：需要数小时甚至数天训练神经网络
   - PatchCore：只需几分钟"记忆"正常样本特征，无需反向传播
   - **实际意义**：快速部署，节省时间和计算资源

2. **检测精度业界领先**
   - 在 MVTec AD（工业检测标准数据集）上精度排名前列
   - 像素级定位准确，能精确标出缺陷位置
   - **实际意义**：漏检率低，误报率低，可靠性高

3. **泛化能力强**
   - 能检测训练时未见过的新型缺陷
   - 对光照、角度变化鲁棒性好
   - **实际意义**：适应生产环境的多样性

4. **可解释性好**
   - 生成的热力图直观显示异常区域
   - 可以追溯判断依据（与哪个正常样本差异大）
   - **实际意义**：便于质检人员复核和分析

#### ⚠️ 局限性

1. **内存占用较大**
   - 需要存储大量正常样本的特征向量
   - 解决方案：本项目通过分块处理降低内存需求

2. **推理速度中等**
   - 比 FastFlow 等模型稍慢
   - 解决方案：使用 GPU 加速，实际速度仍可满足工业需求

#### 📊 性能对比（MVTec AD 数据集）

| 指标 | PatchCore | PaDiM | FastFlow |
|-----|-----------|-------|----------|
| 图像级准确率 | **99.6%** | 97.9% | 98.7% |
| 像素级准确率 | **98.1%** | 96.5% | 97.2% |
| 推理速度 | 20 FPS | 30 FPS | 50 FPS |
| GPU 内存 | 2GB | 1GB | 1.5GB |

**结论**：PatchCore 在精度和泛化性上的优势，远超过其在速度和内存上的劣势，是工业应用的最佳选择。

---

## 🔄 系统工作原理

### 系统架构概览

下图展示了 Tiled Ensemble 的完整系统架构，从输入图像到最终输出的整个流程：

![Tiled Ensemble 系统架构](system_architecture.png)

**架构说明：**

1. **Tiling Mechanism（分块机制）**
   - 将输入的大尺寸图像切分成多个小块（tiles）
   - 本项目配置：512×512 图像 → 4 个 256×256 的块
   - 每个块独立处理，提高检测精度和效率

2. **Ensemble of Models（模型集成）**
   - 每个 tile 对应一个独立训练的 PatchCore 模型
   - 4 个模型并行工作，分别检测各自区域
   - 集成学习提高整体检测性能和鲁棒性

3. **Merging Mechanism（合并机制）**
   - 将各个 tile 的预测结果拼接成完整的异常热力图
   - 合并各模型的异常分数，计算整体评估结果
   - 保证结果的连续性和一致性

4. **Post-processing（后处理流程）**
   - **Smoothing（平滑）**：消除 tile 拼接处的接缝伪影
   - **Normalize（归一化）**：将异常分数映射到 [0, 1] 区间
   - **Threshold（阈值）**：应用阈值判断 OK/NG（默认 0.5）
   - **Visualize（可视化）**：生成热力图和三合一结果图
   - **Metrics（指标）**：计算评估指标（准确率、F1等）

5. **Pipeline（流水线）**
   - 整个流程自动化串联
   - 从原始图像到最终判断结果一键完成
   - 支持批量处理多张图像

---

### 训练流程

下面用通俗语言解释系统如何"学习"正常产品的样子：

```
┌──────────────────────────────────────────────────────┐
│ 第1步：准备数据                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 收集 100+ 张正常产品图片（良品）                   │
│ • 可选：收集少量缺陷图片用于测试（非必需）           │
│ • 图片要求：清晰、光照均匀、拍摄角度一致             │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第2步：图像预处理                                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 自动裁剪黑色背景（保留PCB有效区域）                │
│ • 统一调整为 512×512 像素                           │
│ • 数据增强：随机旋转、亮度调整（增加鲁棒性）         │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第3步：分块处理                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 将 512×512 图像切成 4 块（2×2 网格）              │
│ • 每块大小：256×256 像素                            │
│ • 为什么分块？处理大图更高效，细节捕捉更准确         │
│                                                      │
│   ┌──────┬──────┐                                  │
│   │ 块0  │ 块1  │  ← 每块独立处理                  │
│   ├──────┼──────┤                                  │
│   │ 块2  │ 块3  │                                  │
│   └──────┴──────┘                                  │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第4步：特征提取（核心步骤）                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 使用预训练的 ResNet 神经网络提取特征               │
│ • 特征包含：纹理、边缘、形状、颜色等高维信息         │
│ • 对每个块建立"正常特征库"（Memory Bank）            │
│                                                      │
│   正常样本1 → [特征向量1]                           │
│   正常样本2 → [特征向量2]  } 存入特征库             │
│   正常样本N → [特征向量N]                           │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第5步：保存模型                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 保存 4 个模型文件（对应 4 个块）                   │
│   - model0_0.ckpt（左上）                           │
│   - model0_1.ckpt（右上）                           │
│   - model1_0.ckpt（左下）                           │
│   - model1_1.ckpt（右下）                           │
│                                                      │
│ • 使用验证集统计信息 保存至stats.json
|   - 最佳阈值                                               │
│   - 正常样本的异常分数范围                           │
│   - 用于后续归一化判断                               │
└──────────────────────────────────────────────────────┘
                        ↓ （可选）
┌──────────────────────────────────────────────────────┐
│ 第6步：自动测试评估                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 用预留的测试样本验证模型效果                       │
│ • 生成评估报告：准确率、误报率、漏检率               │
│ • 保存可视化结果到 results/ 目录                     │
└──────────────────────────────────────────────────────┘

⏱️  整个训练过程通常只需 5-15 分钟（取决于数据量）
```

**关键概念解释：**

- **特征提取**：就像人眼看图时会注意纹理、颜色、形状，神经网络也会提取这些抽象特征
- **特征库（Memory Bank）**：就像建立一个"正常产品档案库"，存储所有正常样本的特征
- **分块训练**：类似于把大海报分成小块分别扫描，最后再拼起来

---

### 预测流程

下面解释系统如何判断一张新图片是正常还是异常：

```
┌──────────────────────────────────────────────────────┐
│ 第1步：加载模型和配置                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 加载 4 个训练好的模型                              │
│ • 加载 stats.json（统计信息）                        │
│ • [可选] 加载 ROI 区域配置                           │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第2步：[可选] 选择感兴趣区域（ROI）                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 首次运行时，弹出窗口让您框选关注区域               │
│ • 用途：忽略文字、标签等已知的"假异常"               │
│ • 操作：鼠标拖动框选 → 按 's' 保存 → 按 'q' 继续    │
│                                                      │
│   ┌─────────────────────────┐                       │
│   │  PCB图                  │                       │
│   │  ┌──────────┐            │                      │
│   │  │  ROI区域 │ ← 只检测这里                     │
│   │  └──────────┘            │                      │
│   │     [文字区域] ← 忽略    │                       │
│   └─────────────────────────┘                       │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第3步：读取待检测图像                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 从指定目录读取图像                                 │
│ • 支持格式：jpg、png、jpeg                          │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第4步：图像预处理（与训练相同）                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 自动裁剪图片背景--->解决高度不一致带来的误报                                   │
│ • 调整为 512×512 像素                               │
│ • 切分成 4 个 256×256 块                            │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第5步：分块预测（核心检测）                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 每个块用对应的模型进行检测：                       │
│                                                      │
│   块0 (左上) + model0_0.ckpt → 异常图0              │
│   块1 (右上) + model0_1.ckpt → 异常图1              │
│   块2 (左下) + model1_0.ckpt → 异常图2              │
│   块3 (右下) + model1_1.ckpt → 异常图3              │
│                                                      │
│ • 检测原理：                                         │
│   1. 提取当前块的特征向量                            │
│   2. 与训练时的"正常特征库"对比                      │
│   3. 计算最小距离（相似度）                          │
│   4. 距离大 → 异常，距离小 → 正常                   │
│                                                      │
│   测试特征 ──计算距离──→ 正常特征库                 │
│   [新图块]              [训练样本1]                 │
│                         [训练样本2]                 │
│                         [训练样本N]                 │
│                              ↓                       │
│                         找最相似的 → 计算异常分数    │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第6步：结果合并与后处理                              │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 拼接 4 个异常图 → 完整异常热力图                   │
│                                                      │
│   ┌────┬────┐      ┌──────────┐                    │
│   │图0 │图1 │      │          │                     │
│   ├────┼────┤  →  │ 完整热力图│                    │
│   │图2 │图3 │      │          │                     │
│   └────┴────┘      └──────────┘                    │
│                                                      │
│ • 接缝平滑：消除拼接处的边界痕迹                     │
│ • 归一化：将分数映射到 [0, 1] 区间                  │
│ • [可选] 应用 ROI mask：只计算关注区域的分数        │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第7步：OK/NG 判断                                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 计算整张图的异常分数（0.0 ~ 1.0）                 │
│                                                      │
│   分数 < 0.5  →  ✅ OK（正常）                      │
│   分数 ≥ 0.5  →  ❌ NG（异常）                      │
│                                                      │
│ • 为什么阈值是 0.5？                                 │
│   训练时会找到最佳分界点，归一化后映射到 0.5         │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 第8步：生成可视化结果                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│ • 生成三合一结果图：                                 │
│                                                      │
│   ┌─────────┬──────────┬──────────┐                │
│   │ 原始图  │ 热力图叠加│ 异常区域 │                 │
│   │         │ OK 0.23  │          │                 │
│   └─────────┴──────────┴──────────┘                │
│                                                      │
│ • 热力图颜色：                                       │
│   - 蓝色/绿色：正常区域                              │
│   - 黄色/橙色：可疑区域                              │
│   - 红色：异常区域                                   │
│                                                      │
│ • 保存文件命名：图片名_判断结果_分数.jpg             │
│   例如：test_001_OK_0.234.jpg                       │
│         test_002_NG_0.678.jpg                       │
└──────────────────────────────────────────────────────┘

⏱️  单张图预测速度：1-2 秒/张（使用 GPU）
```

**关键概念解释：**

- **异常分数**：数值越高表示越不正常，0表示完全正常，1表示完全异常
- **热力图**：用颜色表示异常程度，红色=异常，蓝色=正常
- **接缝平滑**：因为图像被切成4块分别检测，拼接时会有边界痕迹，需要平滑处理
- **ROI（Region of Interest）**：感兴趣区域，只检测这些区域，忽略其他位置

---

### 测试流程

测试和预测的主要区别：

| 对比项 | 预测（Predict） | 测试（Test） |
|--------|----------------|-------------|
| **目的** | 检测未知样本 | 评估模型性能 |
| **数据** | 新的生产图片 | 已知标签的测试集 |
| **输出** | OK/NG + 可视化 | 准确率、F1分数等指标 |
| **使用时机** | 生产环境实时检测 | 模型验证和调优 |

**测试流程：**

```
训练完成后 → 自动运行测试
         ↓
使用测试集（正常 + 异常样本）
         ↓
计算评估指标：
  • 图像级准确率（整张图判断对错）
  • 像素级准确率（缺陷位置标注精度）
  • F1 分数（准确率和召回率的平衡）
  • AUROC（受试者工作特征曲线下面积）
         ↓
保存评估报告和可视化结果
```

---

### 预测结果示例

下面展示三个实际的预测结果，帮助您直观理解系统的检测效果：

#### 示例 1：正常样本 - OK（异常分数：0.455）

![预测结果示例1](examples/Image_534_OK_0.455.jpg)

**分析说明：**
- **判断结果**：✅ OK（正常）
- **异常分数**：0.455（< 0.5 阈值，判定为正常）
- **热力图分析**：
  - 大部分区域呈现蓝色/绿色（正常）
  - 黄色变压器区域有轻微异常反应（电感元件的正常现象）
  - 红色圈出的区域是预设的ROI关注区域
- **结论**：整体得分低于阈值，PCB板无明显缺陷

#### 示例 2：正常样本 - OK（异常分数：0.460）

![预测结果示例2](examples/Image_2026_OK_0.460.jpg)

**分析说明：**
- **判断结果**：✅ OK（正常）
- **异常分数**：0.460（< 0.5 阈值，判定为正常）
- **热力图分析**：
  - 整体呈现蓝色调，异常程度很低
  - 黄色变压器区域的异常值略高（这是正常的，因为该元件纹理特殊）
  - 右侧的异常区域图几乎全黑，说明无明显异常
- **结论**：这是一个典型的良品样本

#### 示例 3：异常样本 - NG（异常分数：0.777）

![预测结果示例3](examples/Image_2665_NG_0.777.jpg)

**分析说明：**
- **判断结果**：❌ NG（异常）
- **异常分数**：0.777（≥ 0.5 阈值，判定为异常）
- **热力图分析**：
  - 黄色变压器区域呈现明显的红色/黄色高亮
  - 热力图叠加显示该区域与正常样本差异显著
  - 右侧的异常区域图清晰显示出缺陷位置（白色区域）
- **缺陷类型**：变压器上的红色 "V" 形标记（训练时未见过的异常）
- **结论**：系统成功检测出明显的产品异常

---

#### 📊 结果对比总结

| 样本 | 判断 | 分数 | 特征描述 |
|------|------|------|----------|
| Image_534 | ✅ OK | 0.455 | 正常PCB，轻微异常值在可接受范围 |
| Image_2026 | ✅ OK | 0.460 | 典型良品，异常值极低 |
| Image_2665 | ❌ NG | 0.777 | 变压器区域存在明显缺陷标记 |

**关键观察点：**
1. **阈值分界清晰**：0.5 作为分界点，能有效区分正常和异常样本
2. **热力图可解释性强**：红色区域直接指示缺陷位置，便于人工复核
3. **误报控制良好**：即使黄色元件在所有样本中都显示较高异常值（因其特殊纹理），但不影响整体判断
4. **细节捕捉能力强**：能检测出小尺寸的异常标记（如示例3的"V"形标记）

---

## 🎯 功能特性

- **分块集成训练**：将大尺寸图像切分成多个 tiles，每个 tile 训练独立模型
- **智能接缝平滑**：自动平滑相邻 tiles 拼接处，消除接缝伪影
- **PCB 背景裁剪**：自动检测并裁剪 PCB 边缘，去除黑色背景干扰
- **ROI 区域选择**：支持指定感兴趣区域，忽略不相关区域的异常
- **可视化输出**：生成原图、热力图叠加、异常区域三合一可视化结果

---

## 📁 文件结构

```
tools/tiled_ensemble/
├── train.py                    # 训练脚本
├── predict.py                  # 预测脚本（独立版，包含完整功能）
├── eval.py                     # 评估脚本
├── ens_config.yaml             # 训练配置文件
├── predict_config.yaml         # 预测配置文件
├── visualize_heatmap.py        # 热图可视化工具
├── roi.json                    # ROI 配置文件（预测时生成）
├── roi_mask.png                # ROI 掩码图像（预测时生成）
└── README.md                   # 本文档
```

## 📚 参考资料

- [Anomalib 官方文档](https://anomalib.readthedocs.io/)
- [PatchCore 论文](https://arxiv.org/abs/2106.08265)
- [Tiled Ensemble 设计思想](https://anomalib.readthedocs.io/en/latest/markdown/guides/reference/pipelines/tiled_ensemble.html)

---

## 🤝 贡献与反馈

如有问题或建议，请联系项目维护者。

---

**最后更新：** 2026-01-12

